name: Test Liquibase Status with Cloud Spanner

on:
  workflow_dispatch:
    inputs:
      app_env:
        description: 'Environment (dev, stage, prod-c)'
        default: 'dev'
        required: true

env:
  CHANGE_LOG_FILE: sql/changelog-root.xml
  JDBC_URL: jdbc:cloudspanner:/projects/${{ vars.GCP_PROJECT_ID }}/instances/demo/databases/demo_liquibase?credentials=/github/workspace/sa-liquibase.json
  SEARCH_PATH: sql

jobs:
  test-liquibase-status:
    runs-on: ubuntu-latest
    steps:
      # Checkout repository to access changelog and pom.xml
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Set up Java
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Cache Maven dependencies
      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Resolve Maven dependencies
      - name: Resolve Maven Dependencies
        run: mvn -B dependency:resolve

      # Copy Maven repository to workspace
      - name: Copy Maven Repository to Workspace
        run: |
          mkdir -p m2-repository
          cp -r ~/.m2/repository/* m2-repository/
        shell: bash

      # Save service account key from secret
      - name: Save Service Account Key
        run: |
          echo "${{ secrets.GCP_SA_KEY }}" > ./sa-liquibase.json
        shell: bash

      # Verify JAR files
      - name: Verify JAR Files
        run: |
          echo "Checking JAR files in m2-repository:"
          ls -l m2-repository/com/google/cloud/google-cloud-spanner-jdbc/2.5.7/google-cloud-spanner-jdbc-2.5.7.jar || echo "Spanner JDBC JAR not found"
          ls -l m2-repository/com/google/cloud/google-cloud-spanner-hibernate-dialect/1.5.0/google-cloud-spanner-hibernate-dialect-1.5.0.jar || echo "Hibernate Dialect JAR not found"
          ls -l m2-repository/com/google/cloud/google-cloud-storage/2.7.2/google-cloud-storage-2.7.2.jar || echo "Storage JAR not found"
          ls -l m2-repository/com/google/guava/guava/33.3.0-jre/guava-33.3.0-jre.jar || echo "Guava JAR not found"
          ls -l m2-repository/com/google/protobuf/protobuf-java/3.25.5/protobuf-java-3.25.5.jar || echo "Protobuf Java JAR not found"
          ls -l m2-repository/com/google/protobuf/protobuf-java-util/3.25.5/protobuf-java-util-3.25.5.jar || echo "Protobuf Java Util JAR not found"
        shell: bash

      # Run Liquibase Status Action
      - name: Liquibase Status Action
        id: liquibase_status
        uses: liquibase-github-actions/status@v4.31.1
        with:
          changelogFile: ${{ env.CHANGE_LOG_FILE }}
          url: ${{ env.JDBC_URL }}
          driver: com.google.cloud.spanner.jdbc.JdbcDriver
          searchPath: ${{ env.SEARCH_PATH }}
          classpath: /github/workspace/m2-repository/com/google/cloud/google-cloud-spanner-jdbc/2.5.7/google-cloud-spanner-jdbc-2.5.7.jar:/github/workspace/m2-repository/com/google/cloud/google-cloud-spanner-hibernate-dialect/1.5.0/google-cloud-spanner-hibernate-dialect-1.5.0.jar:/github/workspace/m2-repository/com/google/cloud/google-cloud-storage/2.7.2/google-cloud-storage-2.7.2.jar:/github/workspace/m2-repository/com/google/guava/guava/33.3.0-jre/guava-33.3.0-jre.jar:/github/workspace/m2-repository/com/google/protobuf/protobuf-java/3.25.5/protobuf-java-3.25.5.jar:/github/workspace/m2-repository/com/google/protobuf/protobuf-java-util/3.25.5/protobuf-java-util-3.25.5.jar
          contextFilter: ${{ inputs.app_env }}
          logLevel: debug
        env:
          JAVA_HOME: /opt/java/openjdk
          GOOGLE_APPLICATION_CREDENTIALS: /github/workspace/sa-liquibase.json

      # Debug Outputs
      - name: Debug Liquibase Status Outputs
        run: |
          echo "Available outputs:"
          echo "${{ toJSON(steps.liquibase_status.outputs) }}"
          echo "Changesets output:"
          echo "${{ steps.liquibase_status.outputs.changesets }}"
        shell: bash